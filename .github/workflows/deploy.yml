name: Deploy to homelab

on:
  push:
    branches:
      - main    # runs only when main is updated

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Allow git to use /home/homebox/homebox-app
        run: |
          git config --global --add safe.directory /home/homebox/homebox-app

      - name: Sanity-check app repo on runner
        run: |
          if [ ! -d /home/homebox/homebox-app/.git ]; then
            echo "ERROR: /home/homebox/homebox-app is missing or not a git repo."
            exit 1
          fi

      - name: Deploy latest code to /home/homebox/homebox-app
        run: |
          set -e
          export PATH="$HOME/.local/bin:$PATH"
          cd /home/homebox/homebox-app

          echo "--- git state before ---"
          git status -sb || true
          echo

          echo "--- fetching origin/main ---"
          git fetch origin

          echo "--- resetting to origin/main ---"
          git reset --hard origin/main

          echo "--- syncing Python environment with uv ---"
          uv sync

      - name: Restart HomeBox Vision service
        run: |
          sudo systemctl restart homebox-vision.service

